<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Citizen Complaint Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      color: #0f172a;
    }

    /* Header Styles */
    .navbar {
      background: #ffffff;
      border-bottom: 1px solid #e2e8f0;
      padding: 0.75rem 1rem;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar-left {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .navbar-logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.2rem;
      font-weight: 700;
      color: #1F3A8A;
      text-decoration: none;
    }

    .navbar-logo-icon {
      width: 2.5rem;
      height: 2.5rem;
      background: linear-gradient(135deg, #1F3A8A, #0EA5A4);
      border-radius: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 700;
    }

    .navbar-menu {
      display: flex;
      gap: 1.5rem;
      list-style: none;
    }

    .navbar-item {
      text-decoration: none;
      color: #475569;
      font-size: 0.95rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      transition: color 0.2s ease;
    }

    .navbar-item:hover {
      color: #0EA5A4;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .navbar-user {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #f1f5f9;
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.9rem;
      color: #1F3A8A;
      font-weight: 500;
    }

    .navbar-logout {
      background: none;
      border: none;
      color: #ef4444;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      transition: color 0.2s ease;
    }

    .navbar-logout:hover {
      color: #dc2626;
    }

    @media (max-width: 768px) {
      .navbar-menu {
        gap: 1rem;
      }

      .navbar-item {
        font-size: 0.85rem;
      }
    }

    .page {
      min-height: 100vh;
      padding: 3rem 1rem;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .text-center {
      text-align: center;
    }

    .title {
      font-size: 2.2rem;
      font-weight: 700;
      color: #1F3A8A;
      margin-bottom: 0.75rem;
    }

    .subtitle {
      font-size: 0.95rem;
      color: #64748b;
    }

    .card {
      margin-top: 2rem;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border-radius: 1.5rem;
      border: 1px solid #e2e8f0;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.2);
      overflow: hidden;
    }

    .card-inner {
      padding: 2rem 2.5rem;
    }

    @media (max-width: 640px) {
      .card-inner {
        padding: 1.5rem 1.25rem;
      }
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1F3A8A;
      display: block;
      margin-bottom: 0.5rem;
    }

    textarea,
    input[type="text"],
    select {
      width: 100%;
      border-radius: 0.9rem;
      border: 2px solid #e2e8f0;
      background: #ffffff;
      padding: 0.7rem 1rem;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    textarea:focus,
    input[type="text"]:focus,
    select:focus {
      border-color: #0EA5A4;
      box-shadow: 0 0 0 2px rgba(14, 165, 164, 0.2);
    }

    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231F3A8A' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1.2em;
      cursor: pointer;
    }

    textarea {
      min-height: 12rem;
      resize: none;
    }

    .mb-6 {
      margin-bottom: 1.5rem;
    }

    .mb-8 {
      margin-bottom: 2rem;
    }

    .flex {
      display: flex;
    }

    .items-center {
      align-items: center;
    }

    .gap-2 {
      gap: 0.5rem;
    }

    .gap-3 {
      gap: 0.75rem;
    }

    .gap-4 {
      gap: 1rem;
    }

    .flex-wrap {
      flex-wrap: wrap;
    }

    .justify-between {
      justify-content: space-between;
    }

    .w-full {
      width: 100%;
    }

    .btn-language {
      padding: 0.45rem 1rem;
      border-radius: 0.7rem;
      border: 1px solid #cbd5f5;
      background: #ffffff;
      color: #475569;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }

    .btn-language.active {
      background: #1F3A8A;
      color: #ffffff;
      border-color: #1F3A8A;
    }

    .btn-language:hover:not(.active) {
      border-color: #0EA5A4;
      background: rgba(14, 165, 164, 0.05);
    }

    .btn-voice {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 0.9rem 1.5rem;
      border-radius: 0.9rem;
      border: 2px solid #e2e8f0;
      background: #ffffff;
      color: #475569;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease, transform 0.1s ease;
    }

    .btn-voice.recording {
      background: #fef2f2;
      border-color: #fecaca;
      color: #b91c1c;
      animation: pulse 1.2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.01);
      }

      100% {
        transform: scale(1);
      }
    }

    .btn-submit {
      width: 100%;
      padding: 1rem 2rem;
      border-radius: 0.9rem;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      color: #ffffff;
      background: linear-gradient(to right, #1F3A8A, #0EA5A4);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.25);
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    .btn-submit:hover {
      transform: scale(1.02);
      box-shadow: 0 16px 34px rgba(15, 23, 42, 0.3);
    }

    .btn-submit:active {
      transform: scale(0.98);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.25);
    }

    .btn-locate {
      padding: 0.7rem 1.5rem;
      border-radius: 0.9rem;
      border: 2px solid #e2e8f0;
      background: #ffffff;
      color: #475569;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .btn-locate:hover:not(:disabled) {
      border-color: #0EA5A4;
      background: rgba(14, 165, 164, 0.05);
    }

    .btn-locate:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .input-row {
      display: flex;
      gap: 0.75rem;
    }

    @media (max-width: 640px) {
      .input-row {
        flex-direction: column;
      }
    }

    .upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      width: 100%;
      padding: 0.9rem 1.5rem;
      border-radius: 0.9rem;
      border: 2px dashed #cbd5f5;
      background: #ffffff;
      color: #475569;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .upload-label:hover {
      background: rgba(14, 165, 164, 0.05);
      border-color: #0EA5A4;
    }

    .error-text {
      margin-top: 0.4rem;
      font-size: 0.8rem;
      color: #b91c1c;
    }

    .ai-indicator {
      margin-top: 0.75rem;
      background: linear-gradient(to right, #eff6ff, #ecfeff);
      border-radius: 0.9rem;
      border: 1px solid #bfdbfe;
      padding: 0.8rem 1rem;
      font-size: 0.85rem;
      color: #1F3A8A;
    }

    .ai-indicator-sub {
      margin-top: 0.25rem;
      font-size: 0.8rem;
      color: #64748b;
    }

    .loader {
      border-radius: 999px;
      border: 2px solid #e5e7eb;
      border-top-color: #0EA5A4;
      width: 14px;
      height: 14px;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Submitted state */
    .submitted-wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
    }

    .submitted-card {
      max-width: 560px;
      width: 100%;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 1.7rem;
      border: 1px solid #e2e8f0;
      padding: 2.5rem 2.5rem;
      text-align: center;
      box-shadow: 0 22px 44px rgba(15, 23, 42, 0.3);
    }

    .submitted-icon {
      width: 5rem;
      height: 5rem;
      border-radius: 999px;
      margin: 0 auto 1.5rem;
      background: linear-gradient(to bottom right, #22c55e, #059669);
    }

    .submitted-title {
      font-size: 1.9rem;
      font-weight: 700;
      color: #1F3A8A;
      margin-bottom: 0.8rem;
    }

    .submitted-text {
      font-size: 0.95rem;
      color: #64748b;
      margin-bottom: 1.25rem;
    }

    .complaint-id {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight: 700;
      color: #0EA5A4;
    }

    .submitted-ai-box {
      margin-bottom: 1.75rem;
      border-radius: 0.9rem;
      border: 1px solid #bbf7d0;
      background: #ecfdf5;
      padding: 0.9rem 1rem;
      font-size: 0.85rem;
      color: #14532d;
    }

    .submitted-ai-label {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .btn-again {
      padding: 0.8rem 2.3rem;
      border-radius: 0.9rem;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      color: #ffffff;
      background: linear-gradient(to right, #1F3A8A, #0EA5A4);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.25);
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    .btn-again:hover {
      transform: scale(1.02);
      box-shadow: 0 16px 34px rgba(15, 23, 42, 0.3);
    }

    .btn-again:active {
      transform: scale(0.98);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.25);
    }
  </style>
</head>

<!-- CITIZEN Header -->
<nav class="navbar navbar-citizen" id="header-citizen">
  <div class="navbar-container">
    <div class="navbar-left">
      <a href="landingpage.html" class="navbar-logo">
        <div class="navbar-logo-icon">S</div>
        <span>SAMBANDH.AI</span>
      </a>
      <ul class="navbar-menu">
        <li><a href="landingpage.html" class="navbar-item">üè† Home</a></li>
        <li><a href="complaintportal.html" class="navbar-item">üìù Register</a></li>
        <li><a href="statustracker.html" class="navbar-item">üîç Track</a></li>
      </ul>
    </div>
    <div class="navbar-right">
      <div class="navbar-user">
        <span id="user-name-display" class="username-display">User</span>
      </div>
      <button class="navbar-logout" onclick="handleLogout()">‚Ü©Ô∏è Logout</button>
    </div>
  </div>
</nav>

<!-- Legacy script removed -->

<body>
  <!-- Submitted view -->
  <div id="submitted-view" class="submitted-wrap" style="display:none;">
    <div class="submitted-card">
      <div class="submitted-icon"></div>
      <h2 class="submitted-title">Complaint Submitted Successfully!</h2>
      <p class="submitted-text">
        Your complaint has been registered with ID:
        <span id="complaint-id" class="complaint-id"></span>
      </p>
      <div class="submitted-ai-box">
        <div class="submitted-ai-label" id="ai-confidence-label">AI Confidence: 0%</div>
        <div class="submitted-ai-text">
          Complaint understood successfully and routed to appropriate department.
        </div>
      </div>
      <button id="btn-again" class="btn-again">Submit Another Complaint</button>
    </div>
  </div>

  <!-- Form view -->
  <div id="form-view" class="page">
    <div class="container">
      <div class="text-center mb-8">
        <h1 class="title">Citizen Complaint Portal</h1>
        <p class="subtitle">
          Submit your grievance and our AI will process it instantly
        </p>
      </div>

      <div class="card">
        <div class="card-inner">
          <!-- Language selector -->
          <div class="mb-6">
            <label>
              <span style="margin-right:0.25rem;">üåê</span>
              Select Language
            </label>
            <div id="language-list" class="flex flex-wrap gap-2"></div>
          </div>

          <!-- Department Filter -->
          <div class="mb-6">
            <label>Department Filter</label>
            <select id="department-filter" required>
              <option value="" disabled selected>Select Department</option>
              <option value="Public Works">Public Works</option>
              <option value="Electricity">Electricity</option>
              <option value="Water Supply">Water Supply</option>
              <option value="Health Services">Health Services</option>
              <option value="Sanitation">Sanitation</option>
              <option value="Education">Education</option>
              <option value="Police">Police</option>
              <option value="Transport">Transport</option>
              <option value="Municipal Corporation">Municipal Corporation</option>
              <option value="Disaster Management">Disaster Management</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <!-- Complaint textarea -->
          <div class="mb-6">
            <label>Describe Your Complaint</label>
            <textarea id="complaint-input"
              placeholder="Explain your issue in detail... Our AI will understand and categorize it automatically."
              required></textarea>
          </div>

          <!-- Voice record -->
          <div class="mb-6">
            <button id="btn-voice" type="button" class="btn-voice">
              <span id="voice-icon">üé§</span>
              <span id="voice-text">Record Voice Complaint (Works in Chrome/Edge)</span>
            </button>
            <p id="voice-error" class="error-text" style="display:none;"></p>
          </div>

          <!-- Upload -->
          <div class="mb-6">
            <label for="file-input" class="upload-label">
              <span>üìé</span>
              <span>Upload Supporting Images</span>
              <input id="file-input" type="file" accept="image/*" multiple style="display:none;" />
            </label>
          </div>

          <!-- Location -->
          <div class="mb-8">
            <label>
              <span style="margin-right:0.25rem;">üìç</span>
              Location Details
            </label>

            <!-- State Dropdown -->
            <div class="mb-4">
              <select id="state-select" required>
                <option value="" disabled selected>Select State</option>
              </select>
            </div>

            <!-- City/District Dropdown -->
            <div class="mb-4">
              <select id="city-select" required disabled>
                <option value="" disabled selected>Select City/District</option>
              </select>
            </div>

            <!-- Detailed Address -->
            <div class="input-row">
              <input id="location-input" type="text" placeholder="Street address, landmark, area..." required />
              <button id="btn-locate" type="button" class="btn-locate">
                <span id="loc-loader" class="loader" style="display:none;"></span>
                <span id="loc-text">Auto-detect</span>
              </button>
            </div>
          </div>

          <!-- Submit -->
          <div class="mb-6">
            <button id="btn-submit" class="btn-submit">Submit Complaint</button>
          </div>

          <!-- AI Indicator -->
          <div id="ai-indicator" style="display:none;">
            <div class="ai-indicator">
              <strong>AI is analyzing your complaint...</strong>
              <div class="ai-indicator-sub">
                Category detected: Infrastructure ‚Ä¢ Priority: Medium
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- My Complaints Section -->
      <div id="my-complaints-section" style="margin-top: 3rem; display: none;">
        <h2 class="title" style="font-size: 1.5rem; margin-bottom: 1.5rem;">My Recent Complaints</h2>
        <div id="complaints-list" style="display: flex; flex-direction: column; gap: 1rem;">
          <!-- Complaints will be rendered here -->
          <div style="text-align: center; color: #64748b;">Loading your complaints...</div>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, doc, setDoc, getDoc, runTransaction, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDSXCVPBxuoA1xtj_e6s5TN7Q94RBXTyLQ",
      authDomain: "sambandh-a4af6.firebaseapp.com",
      projectId: "sambandh-a4af6",
      storageBucket: "sambandh-a4af6.firebasestorage.app",
      messagingSenderId: "24348920280",
      appId: "1:24348920280:web:189bb7b6739a0609054aad",
      measurementId: "G-N2JVRVEWN9"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentUserName = "Citizen"; // Default
    let unsubscribeComplaints = null;
    let isFirstLoad = true;

    // Monitor Auth State & Enforce Role
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;

        try {
          // STRICT: Fetch specific document from 'citizen' collection
          const userDocRef = doc(db, "citizen", user.uid);
          const userDoc = await getDoc(userDocRef);

          if (userDoc.exists()) {
            const data = userDoc.data();

            // 1. Role Enforcement
            if (data.role && data.role !== 'citizen') {
              console.warn("User role is not 'citizen':", data.role);
              alert("Access Denied: You must be a Citizen to access this portal.");
              await signOut(auth);
              window.location.href = 'login.html';
              return;
            }

            // 2. Name Display (Force from DB)
            if (data.name) {
              // Capitalize
              const dbName = data.name.trim().split(' ')
                .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
                .join(' ');

              currentUserName = dbName;

              // Force Update UI
              const nameEl = document.getElementById('user-name-display');
              if (nameEl) nameEl.textContent = currentUserName;

              // Update all class instances
              document.querySelectorAll('.username-display').forEach(el => el.textContent = currentUserName);

              console.log("‚úì User authenticated:", currentUserName);
            } else {
              console.warn("User document exists but 'name' field is missing/empty. Using auth name.");
              const displayName = user.displayName || "Citizen";
              currentUserName = displayName;
              document.getElementById('user-name-display').textContent = displayName;
            }
          } else {
            // Document doesn't exist = Not a registered Citizen
            console.log("No citizen document found. Checking auth displayName...");
            
            // If not in citizen collection, try displayName from Firebase Auth
            if (user.displayName) {
              currentUserName = user.displayName;
              document.getElementById('user-name-display').textContent = user.displayName;
              console.log("‚úì Using auth displayName:", user.displayName);
            } else {
              console.warn("No citizen collection document and no displayName in auth");
              currentUserName = "Citizen";
              document.getElementById('user-name-display').textContent = "Citizen";
            }
          }

          // Initialize Complaints List Listener
          initComplaintsListener(user.uid);

          // Show "My Complaints" section
          const section = document.getElementById('my-complaints-section');
          if (section) section.style.display = 'block';

          isFirstLoad = false;

        } catch (e) {
          console.error("Auth Data Fetch Error:", e);
          // Silent fail - don't logout, just use default name
          currentUserName = user.displayName || "Citizen";
          document.getElementById('user-name-display').textContent = currentUserName;
          
          // Still try to initialize complaints
          try {
            initComplaintsListener(user.uid);
            const section = document.getElementById('my-complaints-section');
            if (section) section.style.display = 'block';
          } catch (err) {
            console.error("Error initializing complaints:", err);
          }
          
          isFirstLoad = false;
        }

      } else {
        // User is NOT logged in - only show alert if not first load
        if (unsubscribeComplaints) unsubscribeComplaints();

        if (!isFirstLoad) {
          // Only show when user explicitly logged out or session expired
          alert("‚ö†Ô∏è Session ended. Please login again.");
          window.location.href = 'login.html';
        } else {
          // First load without authentication - redirect silently
          console.log("No active session on page load");
          window.location.href = 'login.html';
          isFirstLoad = false;
        }
      }
    });

    // Handle logout: "once we log in, we have to log out to log out. It's won't log out automatically."
    window.handleLogout = async () => {
      try {
        await signOut(auth);
        localStorage.clear();
        window.location.href = 'login.html';
      } catch (error) {
        console.error("Logout Error:", error);
      }
    };

    // --- ID Generaton Logic ---
    async function generateNextComplaintId() {
      const counterRef = doc(db, "counters", "complaints");
      try {
        const nextCount = await runTransaction(db, async (transaction) => {
          const counterDoc = await transaction.get(counterRef);
          let currentCount = 0;
          if (counterDoc.exists()) {
            currentCount = counterDoc.data().currentCount || 0;
          }
          const next = currentCount + 1;
          transaction.set(counterRef, { currentCount: next }, { merge: true });
          return next;
        });

        // Format: 000001-999999, then A00001...
        if (nextCount <= 999999) {
          return `CMPT-2026-${String(nextCount).padStart(6, '0')}`;
        } else {
          const offset = nextCount - 1000000;
          const alphaIndex = Math.floor(offset / 99999);
          const numIndex = (offset % 99999) + 1;
          const charCode = 65 + alphaIndex; // 65 is 'A'
          // Safety check for char code if it exceeds Z (unlikely for this scale)
          const charStr = String.fromCharCode(charCode);
          return `CMPT-2026-${charStr}${String(numIndex).padStart(5, '0')}`;
        }
      } catch (e) {
        console.error("ID Generation Error:", e);
        // Fallback
        return `CMPT-2026-${Date.now().toString().slice(-6)}`;
      }
    }

    // --- Fetch User Complaints (Updated to 'citizen' collection) ---
    function initComplaintsListener(uid) {
      const listContainer = document.getElementById('complaints-list');
      if (!listContainer) return;

      // Fetch from: citizen/{uid}/complaints
      const q = query(collection(db, "citizen", uid, "complaints"), orderBy("createdAt", "desc"));

      unsubscribeComplaints = onSnapshot(q, (snapshot) => {
        listContainer.innerHTML = '';
        if (snapshot.empty) {
          listContainer.innerHTML = '<div style="text-align:center;color:#64748b;padding:1rem;">No complaints found.</div>';
          return;
        }

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const item = document.createElement('div');
          item.className = 'card';
          item.style.marginTop = '0.5rem';
          item.style.marginBottom = '1.5rem';
          item.style.padding = '1.5rem';
          item.style.borderRadius = '1rem';
          item.style.border = '1px solid #e2e8f0';
          item.style.background = 'white';

          const dateStr = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'Just now';
          let addressDisplay = data.location || '';
          if (!addressDisplay && data.city) addressDisplay = `${data.city}, ${data.state}`;

          item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.5rem;">
                        <div>
                            <span style="font-weight:700; color:#1F3A8A; font-family:monospace; font-size:1.1rem;">${docSnap.id}</span>
                            <span style="font-size:0.8rem; color:#64748b; margin-left:0.5rem;">${dateStr}</span>
                        </div>
                        <span style="background:${getStatusColor(data.status)}; color:#1e293b; padding:0.2rem 0.6rem; border-radius:999px; font-size:0.8rem; font-weight:600;">${data.status}</span>
                    </div>
                    <div style="font-weight:600; color:#334155; margin-bottom:0.5rem;">${data.department}</div>
                    <p style="color:#475569; font-size:0.95rem; margin-bottom:1rem; line-height:1.5;">${data.description}</p>
                    <div style="font-size:0.85rem; color:#64748b; display:flex; gap:1rem; align-items:center;">
                        <span>üìç ${addressDisplay}</span>
                    </div>
                `;
          listContainer.appendChild(item);
        });
      }, (error) => {
        console.error("Listener Error:", error);
        listContainer.innerHTML = '<div style="text-align:center;color:red;">Error loading complaints.</div>';
      });
    }

    function getStatusColor(status) {
      const s = (status || '').toLowerCase();
      if (s === 'resolved') return '#bbf7d0'; // green-200
      if (s === 'in progress') return '#fef08a'; // yellow-200
      if (s === 'pending') return '#e2e8f0'; // slate-200
      return '#f1f5f9';
    }

    // ---- State ----
    const languages = [
      { code: 'en-IN', name: 'English' },
      { code: 'hi-IN', name: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä' },
      { code: 'bn-IN', name: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' },
      { code: 'ta-IN', name: '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç' },
      { code: 'te-IN', name: '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å' }
    ];

    let selectedLanguage = 'en-IN';
    let isRecording = false;
    let isDetectingLocation = false;
    let aiConfidence = 0;
    let recognition = null;

    const statesData = {
      'Andhra Pradesh': ['Visakhapatnam', 'Vijayawada', 'Guntur', 'Nellore', 'Kurnool', 'Tirupati'],
      'Arunachal Pradesh': ['Itanagar', 'Naharlagun', 'Pasighat', 'Tawang'],
      'Assam': ['Guwahati', 'Silchar', 'Dibrugarh', 'Jorhat', 'Nagaon', 'Tinsukia'],
      'Bihar': ['Patna', 'Gaya', 'Bhagalpur', 'Muzaffarpur', 'Darbhanga', 'Purnia'],
      'Chhattisgarh': ['Raipur', 'Bhilai', 'Bilaspur', 'Korba', 'Durg', 'Rajnandgaon'],
      'Goa': ['Panaji', 'Margao', 'Vasco da Gama', 'Mapusa', 'Ponda'],
      'Gujarat': ['Ahmedabad', 'Surat', 'Vadodara', 'Rajkot', 'Bhavnagar', 'Jamnagar'],
      'Haryana': ['Gurugram', 'Faridabad', 'Panipat', 'Ambala', 'Karnal', 'Hisar'],
      'Himachal Pradesh': ['Shimla', 'Dharamshala', 'Solan', 'Mandi', 'Kullu', 'Hamirpur'],
      'Jharkhand': ['Ranchi', 'Jamshedpur', 'Dhanbad', 'Bokaro', 'Deoghar', 'Hazaribagh'],
      'Karnataka': ['Bengaluru', 'Mysuru', 'Mangaluru', 'Hubli', 'Belagavi', 'Davangere'],
      'Kerala': ['Thiruvananthapuram', 'Kochi', 'Kozhikode', 'Thrissur', 'Kollam', 'Kannur'],
      'Madhya Pradesh': ['Bhopal', 'Indore', 'Gwalior', 'Jabalpur', 'Ujjain', 'Sagar'],
      'Maharashtra': ['Mumbai', 'Pune', 'Nagpur', 'Thane', 'Nashik', 'Aurangabad'],
      'Manipur': ['Imphal', 'Thoubal', 'Bishnupur', 'Churachandpur'],
      'Meghalaya': ['Shillong', 'Tura', 'Nongstoin', 'Jowai'],
      'Mizoram': ['Aizawl', 'Lunglei', 'Champhai', 'Serchhip'],
      'Nagaland': ['Kohima', 'Dimapur', 'Mokokchung', 'Tuensang'],
      'Odisha': ['Bhubaneswar', 'Cuttack', 'Rourkela', 'Berhampur', 'Sambalpur', 'Puri'],
      'Punjab': ['Chandigarh', 'Ludhiana', 'Amritsar', 'Jalandhar', 'Patiala', 'Bathinda'],
      'Rajasthan': ['Jaipur', 'Jodhpur', 'Udaipur', 'Kota', 'Ajmer', 'Bikaner'],
      'Sikkim': ['Gangtok', 'Namchi', 'Gyalshing', 'Mangan'],
      'Tamil Nadu': ['Chennai', 'Coimbatore', 'Madurai', 'Tiruchirappalli', 'Salem', 'Tirunelveli'],
      'Telangana': ['Hyderabad', 'Warangal', 'Nizamabad', 'Khammam', 'Karimnagar', 'Mahbubnagar'],
      'Tripura': ['Agartala', 'Udaipur', 'Dharmanagar', 'Kailashahar'],
      'Uttar Pradesh': ['Lucknow', 'Kanpur', 'Ghaziabad', 'Agra', 'Varanasi', 'Meerut', 'Prayagraj'],
      'Uttarakhand': ['Dehradun', 'Haridwar', 'Roorkee', 'Haldwani', 'Rudrapur', 'Nainital'],
      'West Bengal': ['Kolkata', 'Howrah', 'Durgapur', 'Asansol', 'Siliguri', 'Bardhaman'],
      'Delhi': ['New Delhi', 'North Delhi', 'South Delhi', 'East Delhi', 'West Delhi', 'Central Delhi'],
      'Puducherry': ['Puducherry', 'Karaikal', 'Mahe', 'Yanam'],
      'Chandigarh': ['Chandigarh'],
      'Jammu and Kashmir': ['Srinagar', 'Jammu', 'Anantnag', 'Baramulla', 'Udhampur'],
      'Ladakh': ['Leh', 'Kargil']
    };

    const complaintInput = document.getElementById('complaint-input');
    const voiceBtn = document.getElementById('btn-voice');
    const voiceIcon = document.getElementById('voice-icon');
    const voiceText = document.getElementById('voice-text');
    const voiceError = document.getElementById('voice-error');

    const locationInput = document.getElementById('location-input');
    const locateBtn = document.getElementById('btn-locate');
    const locLoader = document.getElementById('loc-loader');
    const locText = document.getElementById('loc-text');
    const stateSelect = document.getElementById('state-select');
    const citySelect = document.getElementById('city-select');

    const submitBtn = document.getElementById('btn-submit');
    const aiIndicator = document.getElementById('ai-indicator');

    const formView = document.getElementById('form-view');
    const submittedView = document.getElementById('submitted-view');
    const complaintIdSpan = document.getElementById('complaint-id');
    const aiConfidenceLabel = document.getElementById('ai-confidence-label');
    const againBtn = document.getElementById('btn-again');
    const fileInput = document.getElementById('file-input');

    // ---- Populate State Dropdown ----
    function populateStates() {
      const states = Object.keys(statesData).sort();
      states.forEach(state => {
        const option = document.createElement('option');
        option.value = state;
        option.textContent = state;
        stateSelect.appendChild(option);
      });
    }

    stateSelect.addEventListener('change', function () {
      const selectedState = this.value;
      citySelect.innerHTML = '<option value="" disabled selected>Select City/District</option>';
      citySelect.disabled = false;

      if (selectedState && statesData[selectedState]) {
        statesData[selectedState].forEach(city => {
          const option = document.createElement('option');
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
      }
    });

    async function detectLocation() {
      if (isDetectingLocation) return;
      if (!navigator.geolocation) { alert('Geolocation is not supported'); return; }
      isDetectingLocation = true;
      locLoader.style.display = 'inline-block';
      locText.textContent = 'Detecting...';
      locateBtn.disabled = true;

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const { latitude, longitude } = position.coords;
          try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1`, {
              headers: { 'User-Agent': 'SAMBANDH.AI Complaint Portal' }
            });
            const data = await response.json();
            if (data && data.address) {
              const address = data.address;
              const state = address.state || '';
              const city = address.city || address.town || address.village || address.county || '';
              const detailedAddress = [address.road, address.suburb].filter(Boolean).join(', ');

              if (state) {
                const stateOption = Array.from(stateSelect.options).find(opt => opt.value.toLowerCase().includes(state.toLowerCase()));
                if (stateOption) {
                  stateSelect.value = stateOption.value;
                  stateSelect.dispatchEvent(new Event('change'));
                  setTimeout(() => {
                    if (city) {
                      const cityOption = Array.from(citySelect.options).find(opt => opt.value.toLowerCase().includes(city.toLowerCase()));
                      if (cityOption) citySelect.value = cityOption.value;
                    }
                  }, 100);
                }
              }
              if (detailedAddress) locationInput.value = detailedAddress;
              else if (data.display_name) locationInput.value = data.display_name.split(',').slice(0, 3).join(', ');
              locText.textContent = 'Location detected!';
              setTimeout(() => { locText.textContent = 'Auto-detect'; }, 2000);
            }
          } catch (error) {
            console.error('Geocoding error:', error);
            alert('Could not fetch address details.');
          } finally {
            isDetectingLocation = false;
            locLoader.style.display = 'none';
            locateBtn.disabled = false;
          }
        },
        (error) => {
          isDetectingLocation = false;
          locLoader.style.display = 'none';
          locText.textContent = 'Auto-detect';
          locateBtn.disabled = false;
          alert('Location detection failed. Allow permission or try again.');
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }
    locateBtn.addEventListener('click', detectLocation);

    // ---- Language & Voice (Existing Logic) ----
    const languageList = document.getElementById('language-list');
    function renderLanguages() {
      languageList.innerHTML = '';
      languages.forEach((lang) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-language' + (lang.code === selectedLanguage ? ' active' : '');
        btn.textContent = lang.name;
        btn.onclick = () => {
          selectedLanguage = lang.code;
          renderLanguages();
          if (recognition && isRecording) { recognition.stop(); isRecording = false; updateVoiceUI(); }
          initSpeechRecognition();
        };
        languageList.appendChild(btn);
      });
    }

    function initSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) { recognition = null; return; }
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = selectedLanguage;
      recognition.onresult = (event) => {
        let finalTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript + ' ';
        }
        if (finalTranscript) {
          complaintInput.value += finalTranscript;
          handleComplaintChange();
        }
      };
      recognition.onerror = (ev) => { voiceError.textContent = 'Error: ' + ev.error; voiceError.style.display = 'block'; isRecording = false; updateVoiceUI(); };
      recognition.onend = () => { isRecording = false; updateVoiceUI(); };
    }

    function updateVoiceUI() {
      if (isRecording) {
        voiceBtn.classList.add('recording');
        voiceIcon.textContent = '‚èπ';
        voiceText.textContent = 'Recording... Click to Stop';
      } else {
        voiceBtn.classList.remove('recording');
        voiceIcon.textContent = 'üé§';
        voiceText.textContent = 'Record Voice Complaint';
      }
    }
    voiceBtn.addEventListener('click', () => {
      voiceError.style.display = 'none';
      if (!recognition) {
        voiceError.textContent = 'Speech recognition not supported.';
        voiceError.style.display = 'block';
        return;
      }
      if (isRecording) recognition.stop();
      else { try { recognition.start(); isRecording = true; updateVoiceUI(); } catch (e) { voiceError.textContent = 'Mic Error'; voiceError.style.display = 'block'; } }
    });

    function handleComplaintChange() {
      if (complaintInput.value.trim().length > 20) aiIndicator.style.display = 'block';
      else aiIndicator.style.display = 'none';
    }
    complaintInput.addEventListener('input', handleComplaintChange);

    // ---- Submit ----
    submitBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const deptFilter = document.getElementById('department-filter');

      if (!complaintInput.value.trim() || !stateSelect.value || !citySelect.value || !locationInput.value.trim() || !deptFilter.value) {
        alert('Please fill in all required fields.');
        return;
      }

      if (recognition && isRecording) {
        recognition.stop();
        isRecording = false;
        updateVoiceUI();
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      try {
        if (!currentUser) throw new Error("User not logged in");

        // 1. Process Images
        const imageFiles = fileInput.files;
        const imagesBase64 = [];
        if (imageFiles.length > 0) {
          for (let i = 0; i < imageFiles.length; i++) {
            const base64 = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = (ev) => resolve(ev.target.result);
              reader.onerror = reject;
              reader.readAsDataURL(imageFiles[i]);
            });
            imagesBase64.push(base64);
          }
        }

        // 2. Generate ID
        const newComplaintId = await generateNextComplaintId();

        // 3. Prepare Data - Save with proper user association
        const complaintData = {
          complaintId: newComplaintId,
          department: deptFilter.value,
          description: complaintInput.value.trim(),
          state: stateSelect.value,
          city: citySelect.value,
          location: locationInput.value.trim(),
          address: locationInput.value.trim(),
          images: imagesBase64,
          status: 'Pending',
          priority: 'Medium',
          userId: currentUser.uid,
          userEmail: currentUser.email,
          userName: currentUserName,
          createdAt: serverTimestamp(),
          category: deptFilter.value,
          language: selectedLanguage
        };

        // 4. Save to User's Complaints (citizen/{uid}/complaints/{customId})
        // This ensures each complaint is tied to the specific user who filed it
        const userComplaintRef = doc(db, "citizen", currentUser.uid, "complaints", newComplaintId);
        await setDoc(userComplaintRef, complaintData);

        // 5. Save to Global Complaints collection (complaints/{customId})
        // For officer/admin dashboard to view all complaints
        const globalRef = doc(db, "complaints", newComplaintId);
        await setDoc(globalRef, {
          ...complaintData,
          userPath: `citizen/${currentUser.uid}`
        });

        console.log("‚úì Complaint saved successfully:", newComplaintId);
        aiConfidence = 94;
        showSubmittedView(newComplaintId);

      } catch (error) {
        console.error("Error submitting complaint:", error);
        alert("Failed to submit complaint: " + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Complaint';
      }
    });

    function showSubmittedView(id) {
      complaintIdSpan.textContent = id;
      aiConfidenceLabel.textContent = 'AI Confidence: ' + aiConfidence + '%';
      formView.style.display = 'none';
      submittedView.style.display = 'flex';

      // Reset form
      complaintInput.value = '';
      locationInput.value = '';
      fileInput.value = '';
    }

    againBtn.addEventListener('click', () => {
      formView.style.display = 'block';
      submittedView.style.display = 'none';
    });

    // ---- Init ----
    populateStates();
    renderLanguages();
    initSpeechRecognition();
  </script>
</body>

</html>